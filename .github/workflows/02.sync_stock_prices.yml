name: Stock Price Sync

on:
  schedule:
    # 日股抓取：每天 16:00 JST → UTC 7:00
    - cron: "0 7 * * *"
    # 日股重试：每天 17:00 JST → UTC 8:00
    #- cron: "0 8 * * *"
    # 美股抓取：每天 7:00 JST → UTC 22:00
    - cron: "0 22 * * *"
    # 美股重试：每天 8:00 JST → UTC 23:00
    #- cron: "0 23 * * *"
  workflow_dispatch:
    inputs:
      mode:
        description: 'Run Mode'
        required: true
        default: 'normal'
        type: choice
        options:
          - normal
          - initial
      market:
        description: 'Target Market'
        required: false
        default: 'JP'
        type: choice
        options:
          - JP
          - US

jobs:
  sync:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.9'

      - name: Install dependencies
        run: |
          pip install pandas yfinance requests supabase

      - name: Run sync script
        env:
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_SERVICE_ROLE_KEY: ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}
          # 获取手动输入参数
          INPUT_MODE: ${{ github.event.inputs.mode }}
          INPUT_MARKET: ${{ github.event.inputs.market }}
        run: |
          UTC_HOUR=$(date -u +%H)
          MARKET=""

          # 1. 优先使用手动输入的 MARKET
          if [ -n "$INPUT_MARKET" ]; then
            MARKET="$INPUT_MARKET"
          else
            # 2. 否则根据时间自动判断
            if [ "$UTC_HOUR" -eq 7 ]; then
              MARKET="JP"
            elif [ "$UTC_HOUR" -eq 8 ]; then
              MARKET="JP"
              echo "IS_RETRY=1" >> $GITHUB_ENV
            elif [ "$UTC_HOUR" -eq 22 ]; then
              MARKET="US"
            elif [ "$UTC_HOUR" -eq 23 ]; then
              MARKET="US"
              echo "IS_RETRY=1" >> $GITHUB_ENV
            else
              echo "Skipping execution (not in schedule window)"
              # 只有在没有手动指定 market 且不在时间窗口时才退出，
              # 但这里是 else 分支，所以意味着没有手动输入。
              exit 0
            fi
          fi
          
          # 设定默认模式
          MODE=${INPUT_MODE:-normal}
          echo "Current Mode: $MODE, Market: $MARKET"
          python scripts/02.sync_stock_prices.py "$MODE" "$MARKET"